<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supabase Verification</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      max-width: 900px;
      margin: 50px auto;
      padding: 20px;
      background: #1a1a1a;
      color: #00ff00;
    }
    h1 { color: #00ff00; }
    .test { 
      margin: 20px 0; 
      padding: 15px; 
      border: 1px solid #333;
      background: #222;
    }
    .success { color: #00ff00; }
    .error { color: #ff4444; }
    .warning { color: #ffaa00; }
    pre {
      background: #111;
      padding: 10px;
      overflow-x: auto;
      border-left: 3px solid #00ff00;
    }
    button {
      background: #00ff00;
      color: #000;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      font-weight: bold;
      margin: 5px;
    }
    button:hover {
      background: #00cc00;
    }
  </style>
</head>
<body>
  <h1>üîç Supabase Database Verification</h1>
  
  <div class="test">
    <h2>Environment Check</h2>
    <div id="env-check">Running checks...</div>
  </div>
  
  <div class="test">
    <h2>Database Tables</h2>
    <button onclick="checkTables()">Check Tables</button>
    <div id="tables-check"></div>
  </div>
  
  <div class="test">
    <h2>Create Test Game</h2>
    <button onclick="createTestGame()">Create Test Game</button>
    <div id="test-game"></div>
  </div>
  
  <div class="test">
    <h2>Query Test Game</h2>
    <input type="text" id="game-id-input" placeholder="Enter game ID" style="width: 300px; padding: 8px;">
    <button onclick="queryGame()">Query Game</button>
    <div id="game-query"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
    
    // Make functions available globally
    window.supabase = null;
    
    // Check environment
    const envCheck = document.getElementById('env-check');
    const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
    const supabaseKey = import.meta.env.VITE_SUPABASE_ANON_KEY;
    
    if (!supabaseUrl || !supabaseKey) {
      envCheck.innerHTML = `
        <p class="error">‚ùå Missing environment variables!</p>
        <p>VITE_SUPABASE_URL: ${supabaseUrl ? '‚úì Set' : '‚úó Missing'}</p>
        <p>VITE_SUPABASE_ANON_KEY: ${supabaseKey ? '‚úì Set' : '‚úó Missing'}</p>
      `;
    } else {
      envCheck.innerHTML = `
        <p class="success">‚úÖ Environment variables found</p>
        <p>URL: ${supabaseUrl.substring(0, 30)}...</p>
        <p>Key: ${supabaseKey.substring(0, 20)}...</p>
      `;
      
      window.supabase = createClient(supabaseUrl, supabaseKey);
    }
    
    window.checkTables = async function() {
      const div = document.getElementById('tables-check');
      div.innerHTML = '<p>Checking tables...</p>';
      
      if (!window.supabase) {
        div.innerHTML = '<p class="error">‚ùå Supabase not initialized</p>';
        return;
      }
      
      const tables = ['games', 'players', 'game_state', 'game_actions'];
      let html = '';
      
      for (const table of tables) {
        try {
          const { data, error, count } = await window.supabase
            .from(table)
            .select('*', { count: 'exact', head: true });
          
          if (error) {
            html += `<p class="error">‚ùå ${table}: ${error.message}</p>`;
          } else {
            html += `<p class="success">‚úÖ ${table}: exists (${count || 0} rows)</p>`;
          }
        } catch (err) {
          html += `<p class="error">‚ùå ${table}: ${err.message}</p>`;
        }
      }
      
      div.innerHTML = html;
    };
    
    window.createTestGame = async function() {
      const div = document.getElementById('test-game');
      div.innerHTML = '<p>Creating test game...</p>';
      
      if (!window.supabase) {
        div.innerHTML = '<p class="error">‚ùå Supabase not initialized</p>';
        return;
      }
      
      try {
        // Generate room code
        const roomCode = Math.random().toString(36).substring(2, 8).toUpperCase();
        
        console.log('Creating game with room code:', roomCode);
        
        // Create game
        const { data: game, error: gameError } = await window.supabase
          .from('games')
          .insert({
            room_code: roomCode,
            status: 'waiting',
            max_players: 2
          })
          .select()
          .single();
        
        if (gameError) {
          div.innerHTML = `<p class="error">‚ùå Failed to create game</p><pre>${JSON.stringify(gameError, null, 2)}</pre>`;
          return;
        }
        
        console.log('Game created:', game);
        
        // Create host player
        const { data: player, error: playerError } = await window.supabase
          .from('players')
          .insert({
            game_id: game.id,
            player_name: 'Test Host',
            player_order: 1,
            is_host: true,
            connection_status: 'connected'
          })
          .select()
          .single();
        
        if (playerError) {
          div.innerHTML = `<p class="error">‚ùå Failed to create player</p><pre>${JSON.stringify(playerError, null, 2)}</pre>`;
          return;
        }
        
        console.log('Player created:', player);
        
        // Update game with host_player_id
        const { error: updateError } = await window.supabase
          .from('games')
          .update({ host_player_id: player.id })
          .eq('id', game.id);
        
        if (updateError) {
          div.innerHTML = `<p class="error">‚ùå Failed to update host_player_id</p><pre>${JSON.stringify(updateError, null, 2)}</pre>`;
          return;
        }
        
        // Create game state
        const { error: stateError } = await window.supabase
          .from('game_state')
          .insert({
            game_id: game.id,
            player_id: player.id,
            scorecard: {},
            dice_values: [1, 2, 3, 4, 5],
            dice_locked: [false, false, false, false, false],
            rolls_remaining: 3
          });
        
        if (stateError) {
          div.innerHTML = `<p class="error">‚ùå Failed to create game state</p><pre>${JSON.stringify(stateError, null, 2)}</pre>`;
          return;
        }
        
        div.innerHTML = `
          <p class="success">‚úÖ Test game created successfully!</p>
          <pre>Game ID: ${game.id}
Room Code: ${roomCode}
Player ID: ${player.id}
Host Player ID: ${player.id}</pre>
          <p class="warning">Copy the Game ID and use it in the "Query Test Game" section below</p>
        `;
        
        document.getElementById('game-id-input').value = game.id;
        
      } catch (err) {
        div.innerHTML = `<p class="error">‚ùå Error: ${err.message}</p><pre>${err.stack}</pre>`;
      }
    };
    
    window.queryGame = async function() {
      const div = document.getElementById('game-query');
      const gameId = document.getElementById('game-id-input').value;
      
      if (!gameId) {
        div.innerHTML = '<p class="error">‚ùå Please enter a game ID</p>';
        return;
      }
      
      div.innerHTML = '<p>Querying game...</p>';
      
      if (!window.supabase) {
        div.innerHTML = '<p class="error">‚ùå Supabase not initialized</p>';
        return;
      }
      
      try {
        // Query game
        const { data: game, error: gameError } = await window.supabase
          .from('games')
          .select(`
            *,
            players (*)
          `)
          .eq('id', gameId)
          .single();
        
        if (gameError) {
          div.innerHTML = `<p class="error">‚ùå Failed to query game</p><pre>${JSON.stringify(gameError, null, 2)}</pre>`;
          return;
        }
        
        div.innerHTML = `
          <p class="success">‚úÖ Game found!</p>
          <pre>${JSON.stringify(game, null, 2)}</pre>
        `;
        
      } catch (err) {
        div.innerHTML = `<p class="error">‚ùå Error: ${err.message}</p><pre>${err.stack}</pre>`;
      }
    };
  </script>
</body>
</html>
